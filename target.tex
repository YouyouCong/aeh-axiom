\subsection{Target}

\begin{defn}
\begin{array}{llcl}
  \text{Roots} & R & :: = &
    \abstwo{k}{h}{\Mkh} \mid \Mmt \\
  \text{Terms} & \Md & ::= &
    _{(\Delta = \bullet)} \app{V}{V} \mid \\
    & & \mid &
    _{(\Delta = \bullet)} \apptwo{\Kmt}{V}{\Hmt} \mid 
    _{(\Delta = h)} \apptwo{\Kmt}{V}{h} \mid 
    _{(\Delta = kh)} \apptwo{\Kk}{V}{h} \\
    & & \mid & 
    _{(\Delta = \bullet)} \apptwo{R}{\Kmt}{\Hmt} \mid
    _{(\Delta = h)} \apptwo{R}{\Kmt}{h} \mid
    _{(\Delta = kh)} \apptwo{R}{\Kk}{h} \\
    & & \mid & 
    _{(\Delta = \bullet)} \apphand{\Hmt}{V}{\Kmt} \mid
    _{(\Delta = h)} \apphand{h}{V}{\Kmt} \mid
    _{(\Delta = kh)} \apphand{h}{V}{\Kk} \\
  \text{Values} & V & ::= &
    x \mid \abs{x}{R} \\
  \text{Continuations} & K & ::= &
    _{(\Delta = k)} k \\
    & & \mid &
    _{(\Delta = \bullet)} \abstwo{x}{h}{R} \mid 
    _{(\Delta = \bullet)} \abstwo{x}{h}{\Mh} \mid 
    _{(\Delta = k)} \abstwo{x}{h}{\Mkh} \\
  \text{Handlers} & H & ::= &
    _{(\Delta = h)} h \mid
    _{(\Delta = \bullet)} \abstwo{x}{r}{R}
\end{array}
\end{defn}

\begin{defn}
\begin{array}{rcll}
  \appthree{\absthree{x}{k}{h}{M}}{V}{K}{H} & = &
    \substthree{M}{x}{V}{k}{K}{h}{H} &
    \rulename{$\beta_v$} \\
  \abs{x}{\app{V}{x}} & = &
    V &
    \rulename{$\eta_v$} \\
  \apptwo{\abstwop{x}{k}{M}}{V}{H} & = &
    \substtwo{M}{x}{V}{h}{H} &
    \rulename{$\beta_{let}$} \\
  \apptwo{\abstwop{k}{h}{M}}{K}{H} & = & 
    \substtwo{M}{k}{K}{h}{H} &
    \rulename{$\beta_{R}$} \\
  \abstwo{k}{h}{\apptwo{R}{k}{h}} & = &
    R &
    \rulename{$\eta_R$} \\
  \apphand{\abstwop{x}{r}{M}}{V}{K} & = &
    \substtwo{M}{x}{V}{r}{\abs{y}{\apptwo{K}{y}{\absp{x}{r}{M}}}} &
    \rulename{$\beta_h$}
\end{array}
\end{defn}

\endinput

handle
  let x = op v in e2
with
  ...

~>

(\kh. (\kh. h @ v k) (\xh. e2÷ k h) h) K• H•

(\kh. h @ v k) (\xh. e2÷ K• h) H•

H• @ v (\xh. e2÷ K• h)   ... H• @ v Kh

---------------------

handle
  let x = e1 in op v
with
  ...

~>

(\kh. e1÷ (\xh. (\kh. h @ v k) k h) h) K• H•

(\kh. e1÷ (\xh. h @ v k) h) K• H•

e1÷ (\xh. h @ v K•) H•   ... h @ v K•